<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    {{template "navbar" .}}

    <div class="container">
        <div class="admin-header">
            <h1>Time Cards</h1>
            <button class="btn btn-primary" onclick="showCreateModal()">Create Time Card</button>
        </div>

        {{if .Error}}
        <div class="alert alert-error">
            {{if eq .Error "title_required"}}Title is required.
            {{else if eq .Error "invalid_repeat_type"}}Invalid repeat type selected.
            {{else if eq .Error "invalid_repeat_every"}}Repeat interval must be between 1 and 100.
            {{else if eq .Error "invalid_day_of_week"}}Invalid day of week.
            {{else if eq .Error "invalid_day_of_month"}}Invalid day of month.
            {{else if eq .Error "invalid_reminder_days"}}Reminder days must be between 0 and 10.
            {{else if eq .Error "timecard_not_found"}}Time card not found.
            {{else if eq .Error "unauthorized"}}You don't have permission to modify this time card.
            {{else if eq .Error "invalid_method"}}Invalid request method.
            {{else if eq .Error "invalid_timecard_id"}}Invalid time card ID.
            {{else if eq .Error "invalid_action"}}Invalid action.
            {{else if eq .Error "server_error"}}An error occurred. Please try again later.
            {{else}}{{.Error}}{{end}}
        </div>
        {{end}}

        {{if .Success}}
        <div class="alert alert-success">
            {{if eq .Success "timecard_created"}}Time card created successfully.
            {{else if eq .Success "timecard_updated"}}Time card updated successfully.
            {{else if eq .Success "timecard_completed"}}Task "{{.CompletedTitle}}" marked as completed! Next occurrence scheduled.
            {{else}}{{.Success}}{{end}}
        </div>
        {{end}}

        <div class="users-table">
            <table id="timecardsTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)" style="cursor: pointer;">Title <span class="sort-indicator"></span></th>
                        <th onclick="sortTable(1)" style="cursor: pointer;">Repeat <span class="sort-indicator"></span></th>
                        <th onclick="sortTable(2)" style="cursor: pointer;">Next Due <span class="sort-indicator"></span></th>
                        <th onclick="sortTable(3)" style="cursor: pointer;">Notifications <span class="sort-indicator"></span></th>
                        <th onclick="sortTable(4)" style="cursor: pointer;">Active <span class="sort-indicator"></span></th>
                        <th onclick="sortTable(5)" style="cursor: pointer;">State <span class="sort-indicator"></span></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="timecardsTableBody">
                    {{range .TimeCards}}
                    <tr data-title="{{.Title}}" data-repeat-days="{{if eq .RepeatType "weekly"}}{{.RepeatEvery}}{{else if eq .RepeatType "monthly"}}{{.RepeatEvery}}{{else}}365{{end}}" data-repeat-type="{{.RepeatType}}" data-next-due="{{.NextDue.Format "2006-01-02"}}" data-active="{{if .IsActive}}1{{else}}0{{end}}" data-status="{{.Status}}">
                        <td>
                            {{if eq .Status "TRIGGERED"}}
                            <form method="POST" action="/timecards/update" style="display: inline;">
                                <input type="hidden" name="timecard_id" value="{{.ID}}">
                                <input type="hidden" name="action" value="complete">
                                <label class="checkbox-label" style="margin: 0; cursor: pointer;">
                                    <input type="checkbox" onchange="this.form.submit()" title="Mark as completed">
                                    <strong style="margin-left: 0.5rem;">{{.Title}}</strong>
                                </label>
                            </form>
                            {{else}}
                            <strong>{{.Title}}</strong>
                            {{end}}
                            {{if .Description}}<br><small>{{.Description}}</small>{{end}}
                        </td>
                        <td>
                            {{if eq .RepeatType "weekly"}}
                                Every {{if eq .RepeatEvery 1}}{{else}}{{.RepeatEvery}} {{end}}week{{if ne .RepeatEvery 1}}s{{end}} on 
                                {{if eq .DayOfWeek 0}}Sunday
                                {{else if eq .DayOfWeek 1}}Monday
                                {{else if eq .DayOfWeek 2}}Tuesday
                                {{else if eq .DayOfWeek 3}}Wednesday
                                {{else if eq .DayOfWeek 4}}Thursday
                                {{else if eq .DayOfWeek 5}}Friday
                                {{else if eq .DayOfWeek 6}}Saturday{{end}}
                            {{else if eq .RepeatType "monthly"}}
                                Every {{if eq .RepeatEvery 1}}{{else}}{{.RepeatEvery}} {{end}}month{{if ne .RepeatEvery 1}}s{{end}} on day {{.DayOfMonth}}
                            {{else if eq .RepeatType "yearly"}}
                                Yearly
                            {{end}}
                        </td>
                        <td>{{.NextDue.Format "Jan 2, 2006"}}</td>
                        <td>
                            {{if .SendSMS}}<span class="badge badge-user">SMS</span> {{end}}
                            {{if .SendEmail}}<span class="badge badge-user">Email</span>{{end}}
                            {{if not .SendSMS}}{{if not .SendEmail}}-{{end}}{{end}}
                        </td>
                        <td>
                            <form method="POST" action="/timecards/update" style="display: inline;">
                                <input type="hidden" name="timecard_id" value="{{.ID}}">
                                <input type="hidden" name="action" value="toggle_active">
                                <button type="submit" class="badge {{if .IsActive}}badge-user{{else}}badge-admin{{end}}" style="border: none; cursor: pointer; padding: 0.25rem 0.75rem;" title="Click to {{if .IsActive}}pause{{else}}activate{{end}}">
                                    {{if .IsActive}}Active{{else}}Paused{{end}}
                                </button>
                            </form>
                        </td>
                        <td>
                            {{if eq .Status "READY"}}<span class="badge" style="background: #3b82f6;">Ready</span>
                            {{else if eq .Status "TRIGGERED"}}<span class="badge" style="background: #f59e0b;">Triggered</span>
                            {{else if eq .Status "DONE_SUCCESS"}}<span class="badge" style="background: #10b981;">Success</span>
                            {{else if eq .Status "DONE_IGNORED"}}<span class="badge" style="background: #6b7280;">Ignored</span>
                            {{else if eq .Status "DONE_FAILED"}}<span class="badge" style="background: #ef4444;">Failed</span>
                            {{else}}<span class="badge">{{.Status}}</span>{{end}}
                        </td>
                        <td class="actions">
                            <button class="btn-icon" onclick="showEditModal({{.ID}}, '{{.Title}}', '{{.Description}}', {{.SendSMS}}, {{.SendEmail}}, '{{.RepeatType}}', {{.RepeatEvery}}, {{.DayOfWeek}}, {{.DayOfMonth}}, {{.ReminderDays}})" title="Edit">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <form method="POST" action="/timecards/update" style="display: inline;">
                                <input type="hidden" name="timecard_id" value="{{.ID}}">
                                <input type="hidden" name="action" value="toggle_active">
                                <button type="submit" class="btn-icon" title="{{if .IsActive}}Pause{{else}}Activate{{end}}">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        {{if .IsActive}}
                                        <rect x="6" y="4" width="4" height="16"></rect>
                                        <rect x="14" y="4" width="4" height="16"></rect>
                                        {{else}}
                                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                        {{end}}
                                    </svg>
                                </button>
                            </form>
                            <form method="POST" action="/timecards/update" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this time card? This action cannot be undone.');">
                                <input type="hidden" name="timecard_id" value="{{.ID}}">
                                <input type="hidden" name="action" value="delete">
                                <button type="submit" class="btn-icon btn-danger" title="Delete">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {{if .RecentLogs}}
                    <tr style="background-color: #f8f9fa;">
                        <td colspan="7" style="padding: 0.5rem 1rem; border-top: none;">
                            <details style="cursor: pointer;">
                                <summary style="font-size: 0.9rem; color: #666; user-select: none;">
                                    <strong>Recent Activity</strong> ({{len .RecentLogs}} entries)
                                </summary>
                                <div style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
                                    {{range .RecentLogs}}
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0.75rem; background-color: white; border-left: 3px solid 
                                        {{if eq .LogType "completed"}}#28a745
                                        {{else if eq .LogType "sent"}}#007bff
                                        {{else if eq .LogType "reminder_sent"}}#ffc107
                                        {{else}}#6c757d{{end}}; border-radius: 3px;">
                                        <div style="display: flex; gap: 0.75rem; align-items: center; flex: 1;">
                                            <span class="badge" style="padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.75rem; font-weight: 600; white-space: nowrap;
                                                {{if eq .LogType "completed"}}background-color: #28a745; color: white;
                                                {{else if eq .LogType "sent"}}background-color: #007bff; color: white;
                                                {{else if eq .LogType "reminder_sent"}}background-color: #ffc107; color: black;
                                                {{else}}background-color: #6c757d; color: white;{{end}}">
                                                {{if eq .LogType "completed"}}Completed
                                                {{else if eq .LogType "sent"}}Sent
                                                {{else if eq .LogType "reminder_sent"}}Reminder
                                                {{else}}{{.LogType}}{{end}}
                                            </span>
                                            <span style="color: #555; font-size: 0.85rem;">{{.Message}}</span>
                                        </div>
                                        <span style="font-size: 0.8rem; color: #888; white-space: nowrap;">{{.CreatedAt.Format "Jan 2, 3:04 PM"}}</span>
                                    </div>
                                    {{end}}
                                </div>
                            </details>
                        </td>
                    </tr>
                    {{end}}
                    {{else}}
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem;">
                            No time cards yet. Click "Create Time Card" to get started.
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Create Time Card Modal -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create Time Card</h2>
                <button class="modal-close" onclick="closeCreateModal()">&times;</button>
            </div>
            <form method="POST" action="/timecards/create">
                <div class="form-group">
                    <label for="create_title">Title *</label>
                    <input type="text" id="create_title" name="title" required>
                </div>

                <div class="form-group">
                    <label for="create_description">Description</label>
                    <textarea id="create_description" name="description" rows="4"></textarea>
                </div>

                <div class="form-group">
                    <label for="create_repeat_type">Repeat *</label>
                    <select id="create_repeat_type" name="repeat_type" onchange="updateCreateRepeatFields()" required>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>

                <div class="form-group" id="create_repeat_every_group">
                    <label for="create_repeat_every">Every</label>
                    <input type="number" id="create_repeat_every" name="repeat_every" min="1" max="100" value="1">
                    <small class="form-hint" id="create_repeat_hint">Number of weeks (1-100)</small>
                </div>

                <div class="form-group" id="create_day_of_week_group">
                    <label for="create_day_of_week">Day of Week</label>
                    <select id="create_day_of_week" name="day_of_week">
                        <option value="0">Sunday</option>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                    </select>
                </div>

                <div class="form-group" id="create_day_of_month_group" style="display: none;">
                    <label for="create_day_of_month">Day of Month</label>
                    <input type="number" id="create_day_of_month" name="day_of_month" min="1" max="31" value="1">
                </div>

                <div class="form-group" id="create_next_due_date_group" style="display: none;">
                    <label for="create_next_due_date">Next Due Date</label>
                    <input type="date" id="create_next_due_date" name="next_due_date">
                    <small class="form-hint">For multi-month repeats, set when the first occurrence should be (leave blank for auto-calculation)</small>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="create_send_sms" name="send_sms">
                        Send SMS notification
                    </label>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="create_send_email" name="send_email">
                        Send Email notification
                    </label>
                </div>

                <div class="form-group">
                    <label for="create_reminder_days">Maximum daily reminders</label>
                    <input type="number" id="create_reminder_days" name="reminder_days" min="0" max="10" value="0">
                    <small class="form-hint">0-10 reminders. Send up to this many daily reminders if task not completed (0 = no reminders)</small>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="createSubmitBtn" disabled>Create Time Card</button>
                </div>
            </form>
        </div>
    </div>

    {{template "timecard_modal" .}}

    {{template "footer" .}}

    <script>
        function showCreateModal() {
            // Load saved preferences from localStorage
            const saved = localStorage.getItem('timecardPreferences');
            if (saved) {
                try {
                    const prefs = JSON.parse(saved);
                    if (prefs.sendSMS !== undefined) document.getElementById('create_send_sms').checked = prefs.sendSMS;
                    if (prefs.sendEmail !== undefined) document.getElementById('create_send_email').checked = prefs.sendEmail;
                    if (prefs.repeatType) document.getElementById('create_repeat_type').value = prefs.repeatType;
                    if (prefs.repeatEvery) document.getElementById('create_repeat_every').value = prefs.repeatEvery;
                    if (prefs.dayOfWeek !== undefined) document.getElementById('create_day_of_week').value = prefs.dayOfWeek;
                    if (prefs.dayOfMonth) document.getElementById('create_day_of_month').value = prefs.dayOfMonth;
                    if (prefs.reminderDays !== undefined) document.getElementById('create_reminder_days').value = prefs.reminderDays;
                } catch (e) {
                    console.error('Error loading preferences:', e);
                }
            }
            document.getElementById('createModal').style.display = 'flex';
            updateCreateRepeatFields();
            updateCreateSubmitButton();
        }

        function saveCreatePreferences() {
            // Save current form values to localStorage
            const prefs = {
                sendSMS: document.getElementById('create_send_sms').checked,
                sendEmail: document.getElementById('create_send_email').checked,
                repeatType: document.getElementById('create_repeat_type').value,
                repeatEvery: document.getElementById('create_repeat_every').value,
                dayOfWeek: parseInt(document.getElementById('create_day_of_week').value),
                dayOfMonth: parseInt(document.getElementById('create_day_of_month').value),
                reminderDays: parseInt(document.getElementById('create_reminder_days').value)
            };
            localStorage.setItem('timecardPreferences', JSON.stringify(prefs));
        }

        function closeCreateModal() {
            document.getElementById('createModal').style.display = 'none';
            document.querySelector('#createModal form').reset();
        }

        function updateCreateRepeatFields() {
            const repeatType = document.getElementById('create_repeat_type').value;
            const repeatEvery = parseInt(document.getElementById('create_repeat_every').value) || 1;
            const repeatEveryGroup = document.getElementById('create_repeat_every_group');
            const dayOfWeekGroup = document.getElementById('create_day_of_week_group');
            const dayOfMonthGroup = document.getElementById('create_day_of_month_group');
            const nextDueDateGroup = document.getElementById('create_next_due_date_group');
            const repeatHint = document.getElementById('create_repeat_hint');

            if (repeatType === 'weekly') {
                repeatEveryGroup.style.display = 'flex';
                dayOfWeekGroup.style.display = 'flex';
                dayOfMonthGroup.style.display = 'none';
                nextDueDateGroup.style.display = 'none';
                repeatHint.textContent = 'Number of weeks (1-100)';
            } else if (repeatType === 'monthly') {
                repeatEveryGroup.style.display = 'flex';
                dayOfWeekGroup.style.display = 'none';
                dayOfMonthGroup.style.display = 'flex';
                // Show next_due_date for multi-month repeats (every 2+ months)
                nextDueDateGroup.style.display = repeatEvery > 1 ? 'flex' : 'none';
                repeatHint.textContent = 'Number of months (1-100)';
            } else if (repeatType === 'yearly') {
                repeatEveryGroup.style.display = 'none';
                dayOfWeekGroup.style.display = 'none';
                dayOfMonthGroup.style.display = 'none';
                nextDueDateGroup.style.display = 'flex';
            }
            
            // Set default next_due_date
            if ((repeatType === 'monthly' && repeatEvery > 1) || repeatType === 'yearly') {
                const nextDueDateInput = document.getElementById('create_next_due_date');
                if (!nextDueDateInput.value) {
                    const now = new Date();
                    if (repeatType === 'yearly') {
                        // Default to current date for yearly
                        const year = now.getFullYear();
                        const month = String(now.getMonth() + 1).padStart(2, '0');
                        const day = String(now.getDate()).padStart(2, '0');
                        nextDueDateInput.value = `${year}-${month}-${day}`;
                    } else {
                        // Default to current month with selected day for monthly
                        const dayOfMonth = parseInt(document.getElementById('create_day_of_month').value) || 1;
                        const year = now.getFullYear();
                        const month = String(now.getMonth() + 1).padStart(2, '0');
                        const day = String(Math.min(dayOfMonth, new Date(year, now.getMonth() + 1, 0).getDate())).padStart(2, '0');
                        nextDueDateInput.value = `${year}-${month}-${day}`;
                    }
                }
            }
        }

        // Check if title is filled and enable/disable submit button
        function updateCreateSubmitButton() {
            const title = document.getElementById('create_title').value.trim();
            const submitBtn = document.getElementById('createSubmitBtn');
            submitBtn.disabled = title.length === 0;
        }

        // Add input listener to title field
        document.getElementById('create_title').addEventListener('input', updateCreateSubmitButton);
        
        // Add event listeners to update field visibility when repeat_every changes
        document.getElementById('create_repeat_every').addEventListener('input', updateCreateRepeatFields);

        // Save preferences when create form is submitted
        document.querySelector('#createModal form').addEventListener('submit', function() {
            saveCreatePreferences();
        });

        // Close modals on escape key (closeCreateModal is local, closeEditModal is in shared template)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeCreateModal();
            }
        });

        // Table sorting functionality
        let sortDirection = {}; // Track sort direction for each column
        
        function sortTable(columnIndex) {
            const table = document.getElementById('timecardsTable');
            const tbody = document.getElementById('timecardsTableBody');
            const allRows = Array.from(tbody.querySelectorAll('tr'));
            
            // Group rows: each timecard row with its optional activity row
            const rowGroups = [];
            for (let i = 0; i < allRows.length; i++) {
                const row = allRows[i];
                // Check if this is a data row (has data-title attribute)
                if (row.dataset.title) {
                    const group = [row];
                    // Check if next row is the activity row
                    if (i + 1 < allRows.length && allRows[i + 1].querySelector('details')) {
                        group.push(allRows[i + 1]);
                        i++; // Skip the activity row in next iteration
                    }
                    rowGroups.push(group);
                }
            }
            
            // Toggle sort direction
            if (!sortDirection[columnIndex]) {
                sortDirection[columnIndex] = 'asc';
            } else if (sortDirection[columnIndex] === 'asc') {
                sortDirection[columnIndex] = 'desc';
            } else {
                sortDirection[columnIndex] = 'asc';
            }
            
            const direction = sortDirection[columnIndex];
            
            // Clear all sort indicators
            table.querySelectorAll('.sort-indicator').forEach(ind => ind.textContent = '');
            
            // Set current column indicator
            const indicator = table.querySelectorAll('th')[columnIndex].querySelector('.sort-indicator');
            indicator.textContent = direction === 'asc' ? ' ▲' : ' ▼';
            
            rowGroups.sort((a, b) => {
                // Sort by the first row (the data row) in each group
                const aRow = a[0];
                const bRow = b[0];
                let aVal, bVal;
                
                switch(columnIndex) {
                    case 0: // Title
                        aVal = aRow.dataset.title.toLowerCase();
                        bVal = bRow.dataset.title.toLowerCase();
                        break;
                    case 1: // Repeat - sort by days between repeats
                        const aType = aRow.dataset.repeatType;
                        const bType = bRow.dataset.repeatType;
                        const aDays = parseInt(aRow.dataset.repeatDays);
                        const bDays = parseInt(bRow.dataset.repeatDays);
                        
                        // Calculate actual days between repeats
                        let aInterval, bInterval;
                        if (aType === 'weekly') aInterval = aDays * 7;
                        else if (aType === 'monthly') aInterval = aDays * 30;
                        else aInterval = 365; // yearly
                        
                        if (bType === 'weekly') bInterval = bDays * 7;
                        else if (bType === 'monthly') bInterval = bDays * 30;
                        else bInterval = 365; // yearly
                        
                        aVal = aInterval;
                        bVal = bInterval;
                        break;
                    case 2: // Next Due
                        aVal = new Date(aRow.dataset.nextDue);
                        bVal = new Date(bRow.dataset.nextDue);
                        break;
                    case 3: // Notifications
                        aVal = aRow.cells[3].textContent.trim();
                        bVal = bRow.cells[3].textContent.trim();
                        break;
                    case 4: // Active
                        aVal = parseInt(aRow.dataset.active);
                        bVal = parseInt(bRow.dataset.active);
                        break;
                    case 5: // State
                        const statusOrder = {
                            'TRIGGERED': 1,
                            'READY': 2,
                            'DONE_SUCCESS': 3,
                            'DONE_IGNORED': 4,
                            'DONE_FAILED': 5
                        };
                        aVal = statusOrder[aRow.dataset.status] || 99;
                        bVal = statusOrder[bRow.dataset.status] || 99;
                        break;
                }
                
                // Compare values
                let comparison = 0;
                if (aVal > bVal) comparison = 1;
                if (aVal < bVal) comparison = -1;
                
                return direction === 'asc' ? comparison : -comparison;
            });
            
            // Reorder row groups in DOM
            rowGroups.forEach(group => {
                group.forEach(row => tbody.appendChild(row));
            });
        }

        // Modals cannot be closed by clicking outside

        // Dropdown menu functionality
        document.querySelector('.dropdown-toggle').addEventListener('click', function(e) {
            e.stopPropagation();
            const menu = this.nextElementSibling;
            menu.classList.toggle('show');
        });

        document.addEventListener('click', function() {
            const menus = document.querySelectorAll('.dropdown-menu');
            menus.forEach(menu => menu.classList.remove('show'));
        });
    </script>
</body>
</html>
